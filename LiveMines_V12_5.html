<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>閃電九宮格 DEMO (含二級玩法)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        html, body {
            height: 100vh;
            overflow: hidden;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
            display: flex;
        }
        .pixel-font {
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            line-height: 1.2;
            text-shadow: 1px 1px 0px #000;
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 450px;
            margin: auto;
        }
        .grid-cell {
            position: relative;
            aspect-ratio: 1 / 1;
            background-color: #333;
            border: 2px solid #555;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: #ddd;
            overflow: hidden;
        }
        .grid-cell.has-bet {
            border-color: #facc15;
            background-color: #4a4a4a;
        }
        .bet-amount-display {
            position: absolute;
            bottom: 5px;
            font-size: 1.25rem;
            font-weight: bold;
            color: #facc15;
            text-shadow: 1px 1px 2px #000;
        }
        .ball {
            position: absolute;
            width: 25%;
            height: 25%;
            background-color: #ef4444;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.7);
            transition: all 0.5s ease-out;
            opacity: 0;
            transform: scale(0);
        }
        .lightning-payout {
            position: absolute;
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            font-weight: bold;
            pointer-events: none;
            opacity: 0;
            transform: scale(1.5);
            transition: opacity 0.3s, transform 0.3s;
            text-shadow: 1px 1px 2px #000, -1px -1px 2px #000;
        }
        .base-payout-display {
            position: absolute;
            top: 4px;
            left: 4px;
            color: rgba(255, 255, 255, 0.6);
            padding: 2px;
            border-radius: 3px;
        }
        .bonus-text-animation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(1.5);
            font-family: 'Press Start 2P', cursive;
            font-size: 1.2rem;
            color: #fde047;
            opacity: 0;
            animation: bonus-flash 1.5s ease-out forwards;
            pointer-events: none;
            text-shadow: 0 0 5px #f59e0b, 0 0 10px #f59e0b;
        }
        @keyframes bonus-flash {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.5); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(2); }
        }
        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #dc2626;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        #winDetails p span.highlight-base { color: #60a5fa; }
        #winDetails p span.highlight-purchased { color: #fcd34d; }
        #winDetails p span.highlight-bonus { color: #fde047; }
        
        #bonus-game-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
        }
        #bonus-choices-container { display: flex; gap: 20px; }
        .bonus-choice {
            width: 150px; height: 200px; background-color: #4a044e;
            border: 3px solid #a855f7; border-radius: 12px;
            cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s;
            display: flex; justify-content: center; align-items: center;
            font-size: 4rem; color: #fde047; text-shadow: 0 0 10px #f59e0b;
        }
        .bonus-choice:hover {
            transform: translateY(-10px);
            box-shadow: 0 0 25px rgba(168, 85, 247, 0.7);
        }
        .bonus-choice.selected-glow {
            box-shadow: 0 0 40px #fde047, 0 0 20px #ffffff;
            transform: translateY(-10px) scale(1.05);
        }
        .bonus-choice.revealed { transform: rotateY(180deg); cursor: default; }
        .bonus-choice .content { transform: rotateY(180deg); }

        .chip-bar { display: flex; justify-content: center; align-items: center; gap: 10px; }
        .chip {
            padding: 8px 16px; border-radius: 9999px;
            background-color: #4b5563; border: 2px solid #6b7280;
            cursor: pointer; transition: all 0.2s ease;
            font-weight: bold;
        }
        .chip.selected-chip {
            background-color: #f59e0b; border-color: #fcd34d;
            transform: scale(1.1); color: #1f2937;
        }
    </style>
</head>
<body class="flex h-screen">

    <div id="toast"></div>

    <main class="flex-grow overflow-y-auto flex flex-col items-center p-4 w-3/4">
        <div id="file-loader-section" class="w-full max-w-2xl text-center my-auto">
            <h1 class="text-3xl font-bold text-yellow-300 mb-2">閃電九宮格 DEMO</h1>
            <p class="text-gray-400">規則: 閃電不重複 & 局部二級玩法</p>
            <div class="mt-2">
                <input type="file" id="configFile" class="hidden" accept=".json">
                <label for="configFile" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer transition-colors">
                    讀取 config.json
                </label>
                <span id="configFileName" class="ml-3 text-gray-400">未選擇檔案</span>
            </div>
        </div>

        <div id="game-wrapper" class="hidden w-full max-w-2xl flex flex-col items-center">
            <div class="grid-container"></div>
            <div id="winDetails" class="w-full max-w-2xl text-sm mt-4 p-4 bg-gray-800 rounded-lg hidden font-mono"></div>
            
            <div class="w-full max-w-2xl text-center mt-4 space-y-4">
                <div class="chip-bar" id="chip-bar"></div>
                 <div class="flex justify-center items-center space-x-4">
                    <button id="undoButton" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">復原</button>
                    <button id="clearButton" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">清除</button>
                </div>
                <div class="flex justify-center items-center space-x-4">
                    <div class="text-lg"><span class="text-gray-400">總押注:</span> <span id="totalBet" class="font-bold text-xl text-white">0</span></div>
                    <div class="text-lg"><span class="text-gray-400">總贏分:</span> <span id="totalWin" class="font-bold text-xl text-green-400">0</span></div>
                </div>
                <div class="flex items-center justify-center space-x-3 pt-2">
                     <input type="checkbox" id="purchaseFeature" class="h-5 w-5 rounded text-yellow-500 focus:ring-yellow-600 border-gray-400 bg-gray-700 disabled:opacity-50" disabled>
                     <label for="purchaseFeature" class="text-gray-300 disabled:opacity-50">購買額外閃電</label>
                </div>
                <div class="pt-2">
                    <button id="startButton" class="w-48 bg-gray-500 text-white font-bold py-3 px-6 rounded-lg text-lg transition-all duration-300 cursor-not-allowed" disabled>開始</button>
                </div>
            </div>
        </div>
    </main>

    <aside class="w-1/4 bg-gray-900/50 p-4 flex flex-col h-full border-l-2 border-gray-700">
        <div class="flex-shrink-0">
            <h2 class="text-2xl font-bold text-yellow-300 border-b-2 border-gray-600 pb-2 mb-4">玩家資訊</h2>
            <div class="space-y-3 text-lg">
                <div><span class="text-gray-400">餘額:</span> <span id="playerBalance" class="font-bold text-white float-right">1000000.00</span></div>
                <div><span class="text-gray-400">總RTP:</span> <span id="runningRtp" class="font-bold text-white float-right">-.-- %</span></div>
            </div>
            <div class="mt-4 pt-4 border-t-2 border-gray-800">
                <div class="flex items-center justify-center space-x-3">
                     <input type="checkbox" id="forceBonus" class="h-5 w-5 rounded text-purple-500 focus:ring-purple-600 border-gray-400 bg-gray-700">
                     <label for="forceBonus" class="text-purple-300">必定觸發二級玩法</label>
                </div>
            </div>
        </div>
        <div class="flex-grow mt-6 flex flex-col min-h-0">
            <h3 class="text-xl font-bold text-yellow-300 border-b-2 border-gray-600 pb-2 mb-2 flex-shrink-0">歷史紀錄</h3>
            <div id="historyLog" class="flex-grow overflow-y-auto pr-2 space-y-2"></div>
        </div>
    </aside>
    
    <div id="bonus-game-modal">
        <div class="text-center">
            <h2 id="bonus-title" class="text-4xl font-bold text-purple-400 mb-4">二級玩法</h2>
            <p id="bonus-status" class="text-xl text-white mb-2"></p>
            <p id="bonus-payout-info" class="text-lg text-yellow-400 mb-8"></p>
            <div id="bonus-choices-container"></div>
        </div>
    </div>


    <script>
        // DOM Elements
        const gridContainer = document.querySelector('.grid-container');
        const totalBetEl = document.getElementById('totalBet');
        const totalWinEl = document.getElementById('totalWin');
        const startButton = document.getElementById('startButton');
        const purchaseFeatureCheckbox = document.getElementById('purchaseFeature');
        const configFileEl = document.getElementById('configFile');
        const configFileNameEl = document.getElementById('configFileName');
        const toastEl = document.getElementById('toast');
        const winDetailsEl = document.getElementById('winDetails');
        const fileLoaderSection = document.getElementById('file-loader-section');
        const gameWrapper = document.getElementById('game-wrapper');
        const playerBalanceEl = document.getElementById('playerBalance');
        const runningRtpEl = document.getElementById('runningRtp');
        const historyLogEl = document.getElementById('historyLog');
        const bonusGameModal = document.getElementById('bonus-game-modal');
        const bonusStatusEl = document.getElementById('bonus-status');
        const bonusPayoutInfoEl = document.getElementById('bonus-payout-info');
        const bonusChoicesContainer = document.getElementById('bonus-choices-container');
        const forceBonusCheckbox = document.getElementById('forceBonus');
        const chipBar = document.getElementById('chip-bar');
        const undoButton = document.getElementById('undoButton');
        const clearButton = document.getElementById('clearButton');

        // Game State
        let config = null;
        let bets = new Map(); 
        let betHistory = [];
        let currentBetAmount = 100;
        const betOptions = [5, 10, 50, 100, 500, 1000];
        let isPlaying = false;

        // Player Stats
        let playerBalance = 1000000;
        let cumulativeTotalBet = 0;
        let cumulativeTotalWin = 0;
        let roundCounter = 0;

        // --- Helper Functions ---
        function weightedRandom(values, weights) {
            if (!values || !weights || values.length !== weights.length) {
                console.error("Invalid weightedRandom inputs");
                return values ? values[0] : null;
            }
            const totalWeight = weights.reduce((acc, w) => acc + w, 0);
            if (totalWeight <= 0) {
                 console.error("Total weight is zero in weightedRandom");
                 return values[0];
            }
            let random = Math.random() * totalWeight;
            for (let i = 0; i < values.length; i++) {
                if (random < weights[i]) return values[i];
                random -= weights[i];
            }
            return values[values.length - 1];
        }
        
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // --- UI Functions ---
        function initializeGrid() {
            gridContainer.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.classList.add('grid-cell');
                cell.dataset.id = i;
                
                const gridNum = document.createElement('span');
                gridNum.textContent = i + 1;
                cell.appendChild(gridNum);

                const basePayoutsDisplay = document.createElement('div');
                basePayoutsDisplay.classList.add('base-payout-display', 'pixel-font');
                if (config && config.mainGame.singleAreaBasePayouts) {
                    const payouts = config.mainGame.singleAreaBasePayouts;
                    basePayoutsDisplay.innerHTML = `1:${payouts[0] || '?'}x<br>2:${payouts[1] || '?'}x<br>3:${payouts[2] || '?'}x`;
                }
                cell.appendChild(basePayoutsDisplay);

                const betAmountEl = document.createElement('div');
                betAmountEl.classList.add('bet-amount-display');
                cell.appendChild(betAmountEl);

                cell.addEventListener('click', () => placeBet(i));
                gridContainer.appendChild(cell);
            }
        }
        
        function initializeChips() {
            chipBar.innerHTML = '';
            betOptions.forEach(amount => {
                const chip = document.createElement('button');
                chip.classList.add('chip');
                chip.dataset.amount = amount;
                chip.textContent = amount;
                if (amount === currentBetAmount) {
                    chip.classList.add('selected-chip');
                }
                chip.addEventListener('click', () => selectBetAmount(amount));
                chipBar.appendChild(chip);
            });
        }

        function selectBetAmount(amount) {
            currentBetAmount = amount;
            document.querySelectorAll('.chip').forEach(c => {
                c.classList.toggle('selected-chip', parseInt(c.dataset.amount) === amount);
            });
        }

        function placeBet(gridId) {
            if (isPlaying) return;
            const currentGridBet = bets.get(gridId) || 0;
            bets.set(gridId, currentGridBet + currentBetAmount);
            betHistory.push({ gridId, amount: currentBetAmount });
            updateGridDisplay(gridId);
            updateUI();
        }

        function updateGridDisplay(gridId) {
            const cell = document.querySelector(`.grid-cell[data-id='${gridId}']`);
            const betAmountEl = cell.querySelector('.bet-amount-display');
            const bet = bets.get(gridId);
            if (bet > 0) {
                betAmountEl.textContent = bet;
                cell.classList.add('has-bet');
            } else {
                betAmountEl.textContent = '';
                cell.classList.remove('has-bet');
            }
        }

        function undoBet() {
            if (isPlaying || betHistory.length === 0) return;
            const lastAction = betHistory.pop();
            const { gridId, amount } = lastAction;
            const currentGridBet = bets.get(gridId) || 0;
            const newBet = currentGridBet - amount;
            if (newBet > 0) {
                bets.set(gridId, newBet);
            } else {
                bets.delete(gridId);
            }
            updateGridDisplay(gridId);
            updateUI();
        }

        function clearBets() {
            if (isPlaying) return;
            bets.clear();
            betHistory = [];
            for (let i=0; i<9; i++) updateGridDisplay(i);
            updateUI();
        }

        function updateUI() {
            let baseBet = 0;
            bets.forEach(amount => baseBet += amount);
            
            const extraCostPercent = Number(config?.mainGame?.extraPurchaseCostPercent ?? 0);
            let displayBet = baseBet;
            if (purchaseFeatureCheckbox.checked) {
                displayBet = baseBet * (1 + extraCostPercent);
            }
            totalBetEl.textContent = displayBet.toFixed(0);
            playerBalanceEl.textContent = playerBalance.toFixed(2);
            
            undoButton.disabled = betHistory.length === 0 || isPlaying;
            clearButton.disabled = bets.size === 0 || isPlaying;

            if (config) {
                 startButton.disabled = isPlaying;
                 if(!isPlaying) {
                    startButton.classList.remove('bg-gray-500', 'cursor-not-allowed');
                    if (startButton.textContent === '開始') {
                        startButton.classList.add('bg-green-600', 'hover:bg-green-700');
                    } else {
                         startButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    }
                 }
            }
        }
        
        async function runGameLogic() {
            const currentRoundBet = parseFloat(totalBetEl.textContent);
            if (!isFinite(currentRoundBet) || currentRoundBet <= 0) {
                 showToast("請至少押注一個格子！");
                 return;
            }
            
            if (playerBalance < currentRoundBet) {
                showToast("餘額不足！");
                return;
            }

            isPlaying = true;
            disableUI();
            
            try {
                playerBalance -= currentRoundBet;
                updateUI();

                document.querySelectorAll('.ball, .lightning-payout').forEach(el => el.remove());

                const baseLightningGrid = new Map();
                const purchasedLightningGrid = new Map();

                // 1. 基礎閃電
                const numBaseStrikes = weightedRandom(config.lightningFeature.strikes.values, config.lightningFeature.strikes.weights);
                if (numBaseStrikes > config.mainGame.numberOfGrids) {
                    showToast(`無效局: 基礎閃電次數 (${numBaseStrikes}) > 格子數`);
                    playerBalance += currentRoundBet;
                    return; 
                }

                let allGridIds = Array.from({ length: config.mainGame.numberOfGrids }, (_, i) => i);
                let shuffledGridIds = shuffleArray(allGridIds);
                const baseTargetGrids = shuffledGridIds.slice(0, numBaseStrikes);

                for (const gridId of baseTargetGrids) {
                    const payout = weightedRandom(config.lightningFeature.payoutMultipliers.values, config.lightningFeature.payoutMultipliers.weights);
                    baseLightningGrid.set(gridId, (baseLightningGrid.get(gridId) || 0) + payout);
                    await animateLightning(gridId, payout, 'base');
                }

                // 2. 購買的閃電
                if (purchaseFeatureCheckbox.checked) {
                    const numPurchasedStrikes = weightedRandom(config.purchasedLightningFeature.strikes.values, config.purchasedLightningFeature.strikes.weights);
                    if (numPurchasedStrikes > config.mainGame.numberOfGrids) {
                        showToast(`無效局: 購買閃電次數 (${numPurchasedStrikes}) > 格子數`);
                        playerBalance += currentRoundBet;
                        return;
                    }
                    shuffledGridIds = shuffleArray(allGridIds);
                    const purchasedTargetGrids = shuffledGridIds.slice(0, numPurchasedStrikes);

                    for (const gridId of purchasedTargetGrids) {
                        const payout = weightedRandom(config.purchasedLightningFeature.payoutMultipliers.values, config.purchasedLightningFeature.payoutMultipliers.weights);
                        purchasedLightningGrid.set(gridId, (purchasedLightningGrid.get(gridId) || 0) + payout);
                        await animateLightning(gridId, payout, 'purchased');
                    }
                }

                // 3. 落球
                const ballLandings = [];
                if (forceBonusCheckbox.checked) {
                    if (bets.size === 0) {
                        showToast("請先押注格子以觸發二級玩法！");
                        playerBalance += currentRoundBet;
                        return; 
                    }
                    const targetGrid = [...bets.keys()][Math.floor(Math.random() * bets.size)];
                    for (let i = 0; i < config.mainGame.numberOfBalls; i++) ballLandings.push(targetGrid);
                } else {
                    for (let i = 0; i < config.mainGame.numberOfBalls; i++) {
                        ballLandings.push(Math.floor(Math.random() * config.mainGame.numberOfGrids));
                        await new Promise(res => setTimeout(res, 300));
                    }
                }
                await animateBalls(ballLandings);

                // 4. 計算結果
                let mainGameWin = 0;
                let bonusWin = 0;
                let bonusEndLevel = 0;
                let winDetailsHtml = '<h3 class="text-lg font-bold text-yellow-200 mb-2">贏分詳情:</h3>';
                const ballCounts = ballLandings.reduce((acc, gridId) => {
                    acc[gridId] = (acc[gridId] || 0) + 1;
                    return acc;
                }, {});
                
                let bonusTriggeredGrid = -1;
                if (ballLandings.length === config.mainGame.numberOfBalls && new Set(ballLandings).size === 1) {
                    bonusTriggeredGrid = ballLandings[0];
                }
                
                const betAmountOnBonusGrid = bets.get(bonusTriggeredGrid) || 0;
                if (bonusTriggeredGrid !== -1 && betAmountOnBonusGrid > 0) {
                    await animateBonusTrigger(bonusTriggeredGrid);
                    const bonusResult = await startBonusGame(betAmountOnBonusGrid);
                    bonusWin = bonusResult.payout;
                    bonusEndLevel = bonusResult.level;
                }

                for (const [gridId, betAmount] of bets.entries()) {
                    const matches = ballCounts[gridId] || 0;
                    let gridWin = 0;
                    let detailText = '';
                    if (matches > 0) {
                        const basePayout = config.mainGame.singleAreaBasePayouts[matches - 1] || 0;
                        const baseWin = betAmount * basePayout;
                        const baseLightningMultiplier = baseLightningGrid.get(gridId) || 0;
                        const purchasedLightningMultiplier = purchasedLightningGrid.get(gridId) || 0;
                        const totalLightningMultiplier = baseLightningMultiplier + purchasedLightningMultiplier;
                        const finalWin = baseWin * (1 + totalLightningMultiplier);
                        gridWin += finalWin;
                        
                        detailText += `格子 ${gridId + 1} (押 ${betAmount}): 中${matches}球 (${basePayout.toFixed(1)}x) * (1`;
                        if(baseLightningMultiplier > 0) detailText += ` + <span class="highlight-base">${baseLightningMultiplier.toFixed(1)}</span>`;
                        if(purchasedLightningMultiplier > 0) detailText += ` + <span class="highlight-purchased">${purchasedLightningMultiplier.toFixed(1)}</span>`;
                        detailText += `) = ${finalWin.toFixed(2)}`;
                    }
                    if (gridWin > 0) {
                        mainGameWin += gridWin;
                        winDetailsHtml += `<p class="mb-1">${detailText}</p>`;
                    }
                }

                if(bonusWin > 0) {
                     winDetailsHtml += `<p class="mb-1">格子 ${bonusTriggeredGrid + 1} (押 ${betAmountOnBonusGrid}): <span class="highlight-bonus">二級玩法 (通關 ${bonusEndLevel} 層)</span> = ${bonusWin.toFixed(2)}</p>`;
                }

                const totalWin = mainGameWin + bonusWin;
                playerBalance += totalWin;

                if(totalWin > 0){
                    winDetailsEl.innerHTML = winDetailsHtml;
                    winDetailsEl.classList.remove('hidden');
                }
                
                totalWinEl.textContent = totalWin.toFixed(2);
                updateStatsAndHistory(currentRoundBet, totalWin);
            } finally {
                resetGame();
            }
        }

        function startBonusGame(betAmount) {
            return new Promise(resolve => {
                bonusGameModal.style.opacity = 1;
                bonusGameModal.style.pointerEvents = 'auto';
                let currentLevel = 0;
                const maxLevel = config.bonusGame.endLevel;
                const levelSettings = config.bonusGame.levelSettings;
                const playLevel = (level) => {
                    bonusStatusEl.textContent = `第 ${level + 1} 層`;
                    const currentPayout = levelSettings.payouts[level];
                    const prevPayout = level > 0 ? levelSettings.payouts[level - 1] : 0;
                    bonusPayoutInfoEl.innerHTML = `本層獎勵: ${(betAmount * currentPayout).toFixed(2)} | 失敗獎勵: ${(betAmount * prevPayout).toFixed(2)}`;
                    bonusChoicesContainer.innerHTML = '';
                    const numTotal = levelSettings.totalChoices[level];
                    const numWin = levelSettings.winChoices[level];
                    let choices = shuffleArray(new Array(numTotal).fill(0).fill(1, 0, numWin));
                    for (let i = 0; i < numTotal; i++) {
                        const choiceEl = document.createElement('div');
                        choiceEl.classList.add('bonus-choice');
                        choiceEl.innerHTML = `<span>?</span><span class="content hidden">${choices[i] === 1 ? '💰' : '💣'}</span>`;
                        choiceEl.addEventListener('click', async () => {
                            const allChoices = bonusChoicesContainer.querySelectorAll('.bonus-choice');
                            allChoices.forEach(c => { c.style.pointerEvents = 'none'; });
                            choiceEl.classList.add('selected-glow');
                            await new Promise(res => setTimeout(res, 1000));
                            allChoices.forEach(c => {
                                c.classList.add('revealed');
                                c.querySelector('span').classList.add('hidden');
                                c.querySelector('.content').classList.remove('hidden');
                            });
                            await new Promise(res => setTimeout(res, 2000));
                            if (choices[i] === 1) {
                                if (level + 1 >= maxLevel) {
                                    endBonusGame({ payout: betAmount * currentPayout, level: level + 1 });
                                } else {
                                    playLevel(level + 1);
                                }
                            } else {
                                endBonusGame({ payout: betAmount * prevPayout, level: level });
                            }
                        }, { once: true });
                        bonusChoicesContainer.appendChild(choiceEl);
                    }
                };
                const endBonusGame = (result) => {
                    bonusGameModal.style.opacity = 0;
                    bonusGameModal.style.pointerEvents = 'none';
                    resolve(result);
                };
                playLevel(currentLevel);
            });
        }
        
        async function animateLightning(gridId, payout, type) {
            const cell = document.querySelector(`.grid-cell[data-id='${gridId}']`);
            cell.style.transition = 'none';
            cell.style.backgroundColor = '#fff';
            const payoutEl = document.createElement('div');
            payoutEl.classList.add('lightning-payout');
            payoutEl.textContent = `+${payout.toFixed(1)}x`;
            if (type === 'base') {
                payoutEl.style.color = '#60a5fa';
                payoutEl.style.top = '10px';
                payoutEl.style.right = '10px';
            } else {
                payoutEl.style.color = '#fcd34d';
                payoutEl.style.top = '30px';
                payoutEl.style.right = '10px';
            }
            cell.appendChild(payoutEl);
            await new Promise(res => setTimeout(res, 50));
            cell.style.transition = 'all 0.2s ease';
            cell.style.backgroundColor = bets.has(gridId) ? '#4a4a4a' : '#333';
            await new Promise(res => setTimeout(res, 50));
            payoutEl.style.opacity = '1';
            payoutEl.style.transform = 'scale(1)';
            await new Promise(res => setTimeout(res, 500));
        }
        async function animateBalls(landings) {
            const ballElements = [];
            for (let i = 0; i < landings.length; i++) {
                const gridId = landings[i];
                const cell = document.querySelector(`.grid-cell[data-id='${gridId}']`);
                const ball = document.createElement('div');
                ball.classList.add('ball');
                ball.style.top = `${20 + i * 15 + Math.random() * 10}%`;
                ball.style.left = `${37.5 + Math.random() * 10}%`;
                cell.appendChild(ball);
                ballElements.push(ball);
            }
            await new Promise(res => setTimeout(res, 100));
            for (const ball of ballElements) {
                ball.style.opacity = '1';
                ball.style.transform = 'scale(1)';
                await new Promise(res => setTimeout(res, 150));
            }
            await new Promise(res => setTimeout(res, 1000));
        }
        async function animateBonusTrigger(gridId) {
            const cell = document.querySelector(`.grid-cell[data-id='${gridId}']`);
            const bonusEl = document.createElement('div');
            bonusEl.classList.add('bonus-text-animation');
            bonusEl.textContent = 'BONUS!';
            cell.appendChild(bonusEl);
            await new Promise(res => setTimeout(res, 1500));
            bonusEl.remove();
        }
        
        function updateStatsAndHistory(bet, win) {
            roundCounter++;
            cumulativeTotalBet += bet;
            cumulativeTotalWin += win;
            const rtp = cumulativeTotalBet > 0 ? (cumulativeTotalWin / cumulativeTotalBet) * 100 : 0;
            runningRtpEl.textContent = `${rtp.toFixed(2)} %`;
            playerBalanceEl.textContent = playerBalance.toFixed(2);
            const historyEntry = document.createElement('div');
            historyEntry.classList.add('bg-gray-800', 'p-2', 'rounded-md', 'text-sm');
            const winLoss = win - bet;
            const winLossColor = winLoss >= 0 ? 'text-green-400' : 'text-red-400';
            const sign = winLoss >= 0 ? '+' : '';
            historyEntry.innerHTML = `
                <div class="flex justify-between font-mono">
                    <span>第 ${roundCounter} 局</span>
                    <span class="${winLossColor}">${sign}${winLoss.toFixed(2)}</span>
                </div>
                <div class="flex justify-between text-xs text-gray-400 mt-1">
                    <span>押注: ${bet.toFixed(2)}</span>
                    <span>贏分: ${win.toFixed(2)}</span>
                </div>
            `;
            historyLogEl.prepend(historyEntry);
        }

        function resetGame() {
             startButton.textContent = '重新一局';
             startButton.classList.remove('bg-green-600', 'hover:bg-green-700');
             startButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
             startButton.disabled = false;
             startButton.classList.remove('cursor-not-allowed');
             isPlaying = false;
             enableUI();
        }
        
        function handleResetClick() {
            totalWinEl.textContent = '0';
            winDetailsEl.innerHTML = '';
            winDetailsEl.classList.add('hidden');
            
            document.querySelectorAll('.ball, .lightning-payout').forEach(el => el.remove());

            betHistory = [];
            
            updateUI();
            
            startButton.textContent = '開始';
            startButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            startButton.classList.add('bg-green-600', 'hover:bg-green-700');
            startButton.disabled = false;
            startButton.classList.remove('cursor-not-allowed');
        }

        function disableUI() {
            purchaseFeatureCheckbox.disabled = true;
            startButton.disabled = true;
            startButton.classList.add('cursor-not-allowed');
            chipBar.querySelectorAll('button').forEach(c => c.disabled = true);
            undoButton.disabled = true;
            clearButton.disabled = true;
        }

        function enableUI() {
            if (config) {
                 purchaseFeatureCheckbox.disabled = false;
                 chipBar.querySelectorAll('button').forEach(c => c.disabled = false);
                 updateUI();
            }
        }

        // --- Event Listeners ---
        purchaseFeatureCheckbox.addEventListener('change', updateUI);
        undoButton.addEventListener('click', undoBet);
        clearButton.addEventListener('click', clearBets);

        configFileEl.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            configFileNameEl.textContent = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    config = JSON.parse(e.target.result);
                    fileLoaderSection.classList.add('hidden');
                    gameWrapper.classList.remove('hidden');
                    purchaseFeatureCheckbox.disabled = false;
                    initializeGrid(); 
                    initializeChips();
                    handleResetClick();
                    clearBets();
                    updateUI();
                } catch (error) {
                    showToast("無效的 config.json 檔案！");
                    config = null;
                }
            };
            reader.readAsText(file);
        });
        
        startButton.addEventListener('click', () => {
             if (!config) {
                 showToast("請先載入 config.json 檔案！");
                 return;
             }
             if (isPlaying) return;
             
             if (startButton.textContent === '開始') {
                 runGameLogic();
             } else {
                 handleResetClick();
             }
        });
        
        // Initial setup
        initializeGrid();
        initializeChips();
        updateUI();

    </script>
</body>
</html>

