<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>閃電九宮格 DEMO (乘法版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            touch-action: manipulation;
        }
        .grid-cell {
            transition: all 0.2s ease-in-out;
            transform-style: preserve-3d;
        }
        .grid-cell.selected {
            transform: scale(0.95);
            border-color: #f59e0b; /* amber-500 */
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.5);
        }
        .ball {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            animation: dropIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }
        @keyframes dropIn {
            from { transform: translateY(-50px) scale(0.5); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        @keyframes lightning-flash {
            0% { background-color: rgba(255, 255, 0, 0); }
            50% { background-color: rgba(255, 255, 0, 0.8); box-shadow: 0 0 30px 10px rgba(255, 255, 0, 0.7); }
            100% { background-color: rgba(255, 255, 0, 0); }
        }
        .lightning-effect {
            animation: lightning-flash 0.4s ease-out;
        }
        .multiplier-text {
            animation: pulse-text 0.5s ease-out;
        }
        @keyframes pulse-text {
            from { transform: scale(1.5); opacity: 0.5; }
            to { transform: scale(1); opacity: 1; }
        }
        .payout-display {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.7rem;
            line-height: 1.1;
            color: #a7f3d0; /* emerald-200 */
            text-shadow: 1px 1px 0 #10b981; /* emerald-500 */
            text-align: left;
            white-space: pre;
        }
        /* (新) 閃電賠率樣式 */
        .base-multiplier {
            color: #93c5fd; /* blue-300 */
            text-shadow: 1px 1px 0 #3b82f6; /* blue-500 */
        }
        .purchased-multiplier {
            color: #fcd34d; /* amber-300 */
            text-shadow: 1px 1px 0 #f59e0b; /* amber-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div id="game-container" class="w-full max-w-2xl mx-auto p-4 md:p-6 bg-gray-800 rounded-2xl shadow-2xl border border-gray-700">

        <!-- 初始讀取畫面 -->
        <div id="loader-screen" class="text-center">
            <h1 class="text-3xl font-bold text-amber-400 mb-4">閃電九宮格 DEMO</h1>
            <p class="text-gray-400 mb-6">請先載入您的 `config.json` 遊戲設定檔。</p>
            <label for="config-loader" class="cursor-pointer bg-amber-500 hover:bg-amber-600 text-gray-900 font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 inline-block">
                選擇設定檔
            </label>
            <input type="file" id="config-loader" class="hidden" accept=".json">
            <p id="loader-error" class="text-red-500 mt-4"></p>
        </div>

        <!-- 遊戲主畫面 (預設隱藏) -->
        <div id="main-game" class="hidden">
            <h1 class="text-2xl font-bold text-center text-amber-400 mb-4">請選擇您要押注的格子</h1>

            <!-- 九宮格 -->
            <div id="grid-board" class="grid grid-cols-3 gap-3 md:gap-4 mb-4 aspect-square">
                <!-- Grid cells will be generated by JS -->
            </div>

            <!-- 訊息顯示區 -->
            <div id="message-area" class="text-center h-8 mb-4 text-lg font-semibold text-yellow-300 transition-opacity duration-300"></div>

            <!-- 控制面板 -->
            <div id="control-panel" class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div>
                        <p class="text-gray-400 text-sm">押注總額</p>
                        <p id="bet-amount-display" class="text-2xl font-bold">NT$ 0</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <input id="purchase-toggle" type="checkbox" class="h-6 w-6 rounded bg-gray-700 border-gray-600 text-amber-500 focus:ring-amber-600">
                        <label for="purchase-toggle" class="font-medium">購買額外閃電</label>
                    </div>
                    <button id="main-action-button" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105 disabled:bg-gray-600 disabled:cursor-not-allowed disabled:transform-none">
                        開始
                    </button>
                </div>
            </div>

            <!-- 結果顯示區 (預設隱藏) -->
            <div id="result-panel" class="hidden mt-4 bg-gray-900/50 p-4 rounded-lg border border-gray-700 text-center">
                 <h2 class="text-xl font-bold text-amber-400 mb-2">結算結果</h2>
                 <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-lg">
                    <p>基礎贏分: <span id="base-win" class="font-bold">0</span></p>
                    <p>閃電贏分: <span id="lightning-win" class="font-bold">0</span></p>
                    <p>二級贏分: <span id="bonus-win" class="font-bold">0</span></p>
                    <p class="col-span-2 sm:col-span-1 text-2xl text-green-400">總贏分: <span id="total-win" class="font-bold">0</span></p>
                 </div>
            </div>
        </div>
    </div>

<script>
    // --- DOM 元素 ---
    const loaderScreen = document.getElementById('loader-screen');
    const mainGame = document.getElementById('main-game');
    const configLoader = document.getElementById('config-loader');
    const loaderError = document.getElementById('loader-error');
    const gridBoard = document.getElementById('grid-board');
    const betAmountDisplay = document.getElementById('bet-amount-display');
    const purchaseToggle = document.getElementById('purchase-toggle');
    const mainActionButton = document.getElementById('main-action-button');
    const messageArea = document.getElementById('message-area');
    const resultPanel = document.getElementById('result-panel');
    const baseWinEl = document.getElementById('base-win');
    const lightningWinEl = document.getElementById('lightning-win');
    const bonusWinEl = document.getElementById('bonus-win');
    const totalWinEl = document.getElementById('total-win');

    // --- 遊戲狀態 ---
    let config = null;
    let selectedGrids = new Set();
    const betPerGrid = 100;
    let gameState = 'betting'; // 'betting', 'animating', 'result'

    // --- 事件監聽 ---
    configLoader.addEventListener('change', handleConfigFileLoad);
    mainActionButton.addEventListener('click', handleMainButtonClick);

    // --- 核心函式 ---

    /**
     * 處理設定檔載入
     */
    function handleConfigFileLoad(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                config = JSON.parse(e.target.result);
                if (config.mainGame && config.lightningFeature && config.purchasedLightningFeature) {
                    loaderScreen.classList.add('hidden');
                    mainGame.classList.remove('hidden');
                    initializeGame();
                } else {
                    throw new Error('設定檔缺少必要的欄位。');
                }
            } catch (error) {
                loaderError.textContent = `讀取設定檔失敗: ${error.message}`;
            }
        };
        reader.onerror = () => {
            loaderError.textContent = '讀取檔案時發生錯誤。';
        };
        reader.readAsText(file);
    }

    /**
     * 初始化遊戲介面
     */
    function initializeGame() {
        gridBoard.innerHTML = '';
        const payouts = config.mainGame.singleAreaBasePayouts;
        const payoutText = `1球:${payouts[0].toFixed(1)}x\n2球:${payouts[1].toFixed(1)}x\n3球:${payouts[2].toFixed(1)}x`;

        for (let i = 1; i <= config.mainGame.numberOfGrids; i++) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell relative flex items-center justify-center text-4xl font-bold bg-gray-700 rounded-lg border-4 border-gray-600 cursor-pointer aspect-square';
            cell.dataset.id = i;
            // (已修改) 加入基礎和購買閃電的獨立顯示區塊
            cell.innerHTML = `
                <div class="payout-display absolute top-1 left-2 z-20">${payoutText}</div>
                <span class="z-10">${i}</span>
                <div class="absolute top-1 right-2 text-lg font-bold z-20 base-multiplier"></div>
                <div class="absolute top-8 right-2 text-lg font-bold z-20 purchased-multiplier"></div>
                <div class="absolute bottom-1 w-full flex justify-center items-end gap-1 h-8 z-20 ball-container"></div>
            `;
            cell.addEventListener('click', () => handleGridClick(i));
            gridBoard.appendChild(cell);
        }
        updateBetDisplay();
    }

    /**
     * 處理格子點擊事件
     */
    function handleGridClick(id) {
        if (gameState !== 'betting') return;
        const cell = gridBoard.querySelector(`[data-id='${id}']`);
        if (selectedGrids.has(id)) {
            selectedGrids.delete(id);
            cell.classList.remove('selected');
        } else {
            selectedGrids.add(id);
            cell.classList.add('selected');
        }
        updateBetDisplay();
    }

    /**
     * 更新押注金額顯示
     */
    function updateBetDisplay() {
        const totalBet = selectedGrids.size * betPerGrid;
        const purchaseCost = purchaseToggle.checked ? totalBet * config.mainGame.extraPurchaseCostPercent : 0;
        betAmountDisplay.textContent = `NT$ ${Math.round(totalBet + purchaseCost)}`;
        mainActionButton.disabled = selectedGrids.size === 0;
    }
    purchaseToggle.addEventListener('change', updateBetDisplay);

    /**
     * 統一處理主按鈕點擊事件
     */
    function handleMainButtonClick() {
        if (gameState === 'betting') {
            startGame();
        } else if (gameState === 'result') {
            resetGame();
        }
    }

    /**
     * 開始遊戲流程
     */
    async function startGame() {
        if (gameState !== 'betting') return;
        if (selectedGrids.size === 0) {
            updateMessage('請先選擇一個或多個格子！', 2000);
            return;
        }
        
        gameState = 'animating';
        mainActionButton.disabled = true;
        purchaseToggle.disabled = true;
        resultPanel.classList.add('hidden');

        // --- 閃電階段 ---
        const lightningGrid = createEmptyGrid(); // (已修改) 建立包含 base 和 purchased 的物件
        await runLightningSequence('base', lightningGrid);
        
        if (purchaseToggle.checked) {
            await runLightningSequence('purchased', lightningGrid);
        }

        // --- 落球階段 ---
        await updateMessage('... 球開始落下 ...', 1000);
        const ballLandings = [];
        for (let i = 0; i < config.mainGame.numberOfBalls; i++) {
            const gridId = random.randint(1, config.mainGame.numberOfGrids);
            ballLandings.push(gridId);
            animateBallDrop(gridId);
            await delay(300);
        }
        
        // --- 結算階段 ---
        await updateMessage('... 結算中 ...', 1000);
        calculateAndDisplayResults(ballLandings, lightningGrid);
    }
    
    /**
     * 執行閃電動畫序列
     */
    async function runLightningSequence(type, lightningGrid) {
        const feature = type === 'base' ? config.lightningFeature : config.purchasedLightningFeature;
        const message = type === 'base' ? '基礎閃電！' : '購買的額外閃電！';
        await updateMessage(message, 1000);

        const numStrikes = weightedRandom(feature.strikes.values, feature.strikes.weights);
        
        for (let i = 0; i < numStrikes; i++) {
            const gridId = random.randint(1, config.mainGame.numberOfGrids);
            const payout = weightedRandom(feature.payoutMultipliers.values, feature.payoutMultipliers.weights);
            lightningGrid[gridId][type] += payout; // (已修改) 更新對應種類的賠率
            animateLightning(gridId, lightningGrid[gridId], type); // (已修改) 傳入種類
            await delay(500);
        }
    }

    /**
     * 計算並顯示結果
     */
    function calculateAndDisplayResults(ballLandings, lightningGrid) {
        const ballCounts = new Counter(ballLandings);
        const bonusTriggered = new Set(ballLandings).size === 1;
        const baseBet = selectedGrids.size * betPerGrid;

        let baseWin = 0;
        let lightningWin = 0;

        for (const gridId of selectedGrids) {
            const matches = ballCounts.get(gridId, 0);
            if (matches > 0 && matches <= config.mainGame.singleAreaBasePayouts.length) {
                const basePayout = config.mainGame.singleAreaBasePayouts[matches - 1];
                // (已修改) 將基礎和購買的閃電賠率加總
                const totalLightningMultiplier = lightningGrid[gridId].base + lightningGrid[gridId].purchased;
                
                baseWin += betPerGrid * basePayout;
                lightningWin += betPerGrid * basePayout * totalLightningMultiplier;
            }
        }
        
        const bonusWin = bonusTriggered ? baseBet * config.bonusGame.expectedPayout : 0;
        const totalWin = baseWin + lightningWin + bonusWin;

        baseWinEl.textContent = `NT$ ${Math.round(baseWin)}`;
        lightningWinEl.textContent = `NT$ ${Math.round(lightningWin)}`;
        bonusWinEl.textContent = `NT$ ${Math.round(bonusWin)}`;
        totalWinEl.textContent = `NT$ ${Math.round(totalWin)}`;
        
        if (bonusTriggered) {
            updateMessage(`三球同格！觸發二級玩法！`, 3000);
        } else {
            updateMessage('本局結束', 3000);
        }

        resultPanel.classList.remove('hidden');
        
        gameState = 'result';
        mainActionButton.disabled = false;
        mainActionButton.textContent = '重新一局';
        mainActionButton.classList.remove('bg-green-600', 'hover:bg-green-700');
        mainActionButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
    }

    /**
     * 重設遊戲
     */
    function resetGame() {
        selectedGrids.clear();
        gameState = 'betting';
        
        // (已修改) 重設時清除兩種閃電賠率的顯示
        document.querySelectorAll('.grid-cell').forEach(cell => {
            cell.classList.remove('selected');
            cell.querySelector('.base-multiplier').textContent = '';
            cell.querySelector('.purchased-multiplier').textContent = '';
            cell.querySelector('.ball-container').innerHTML = '';
            cell.classList.remove('lightning-effect');
        });

        resultPanel.classList.add('hidden');
        purchaseToggle.disabled = false;
        messageArea.textContent = '';
        
        mainActionButton.textContent = '開始';
        mainActionButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        mainActionButton.classList.add('bg-green-600', 'hover:bg-green-700');
        
        updateBetDisplay();
        mainActionButton.disabled = false;
    }

    // --- 動畫函式 ---
    function animateLightning(gridId, gridMultipliers, type) {
        const cell = gridBoard.querySelector(`[data-id='${gridId}']`);
        // (已修改) 根據種類選擇對應的顯示元素
        const multiplierEl = type === 'base' 
            ? cell.querySelector('.base-multiplier') 
            : cell.querySelector('.purchased-multiplier');
        
        cell.classList.add('lightning-effect');
        // (已修改) 顯示對應種類的總賠率
        multiplierEl.textContent = `x${gridMultipliers[type].toFixed(1)}`;
        multiplierEl.classList.add('multiplier-text');

        setTimeout(() => {
            cell.classList.remove('lightning-effect');
            multiplierEl.classList.remove('multiplier-text');
        }, 500);
    }

    function animateBallDrop(gridId) {
        const cell = gridBoard.querySelector(`[data-id='${gridId}']`);
        const ballContainer = cell.querySelector('.ball-container');
        const ball = document.createElement('div');
        ball.className = 'ball w-6 h-6 bg-red-500 rounded-full border-2 border-red-300 shadow-md';
        ballContainer.appendChild(ball);
    }

    async function updateMessage(text, duration) {
        messageArea.textContent = text;
        if (duration) {
            await delay(duration);
        }
    }

    // --- 輔助工具 ---
    function weightedRandom(values, weights) {
        const totalWeight = weights.reduce((a, b) => a + b, 0);
        let randomNum = Math.random() * totalWeight;
        for (let i = 0; i < values.length; i++) {
            if (randomNum < weights[i]) {
                return values[i];
            }
            randomNum -= weights[i];
        }
        return values[values.length - 1];
    }

    // (已修改) 建立包含 base 和 purchased 屬性的物件
    function createEmptyGrid() {
        const grid = {};
        for (let i = 1; i <= config.mainGame.numberOfGrids; i++) {
            grid[i] = { base: 0, purchased: 0 };
        }
        return grid;
    }

    const random = {
        randint: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
    };

    class Counter {
        constructor(arr = []) {
            this.counts = {};
            for (const item of arr) {
                this.counts[item] = (this.counts[item] || 0) + 1;
            }
        }
        get(key, defaultValue = 0) {
            return this.counts[key] || defaultValue;
        }
    }

    const delay = ms => new Promise(res => setTimeout(res, ms));
    const copy = obj => JSON.parse(JSON.stringify(obj));

</script>
</body>
</html>
